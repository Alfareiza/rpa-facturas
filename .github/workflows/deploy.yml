name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: ~/Projects/rpa-facturas-mutualser
  SERVICE_NAME: rpa-facturas-mutualser

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          install -m 0700 -d ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash -s << 'EOF'
          set -x  # Enable debug output
          
          cd ${{ env.DEPLOY_PATH }}
          
          echo "=========================================="
          echo "Starting deployment for ${{ env.SERVICE_NAME }}"
          echo "=========================================="
          
          BEFORE_COMMIT=$(git rev-parse HEAD)
          echo "Current commit: $BEFORE_COMMIT"
          
          echo "==> Pulling latest changes from Git"
          git pull
          
          AFTER_COMMIT=$(git rev-parse HEAD)
          
          if [ "$BEFORE_COMMIT" = "$AFTER_COMMIT" ]; then
            echo "==> No new commits, repository already up to date"
          else
            echo "==> Updated from $BEFORE_COMMIT to $AFTER_COMMIT"
          fi
          
          echo "==> Checking virtual environment"
          if [ ! -d .venv ]; then
            echo "==> Creating virtual environment"
            make venv
            VENV_CREATED=true
          else
            echo "==> Virtual environment already exists"
            VENV_CREATED=false
          fi
          
          REQUIREMENTS_CHANGED=false
          if [ -f requirements.txt ]; then
            if [ "$VENV_CREATED" = true ]; then
              echo "==> New virtual environment created, installing dependencies"
              REQUIREMENTS_CHANGED=true
            elif [ "$BEFORE_COMMIT" != "$AFTER_COMMIT" ]; then
              if git diff --name-only $BEFORE_COMMIT $AFTER_COMMIT | grep -q '^requirements.txt$'; then
                echo "==> requirements.txt changed, updating dependencies"
                REQUIREMENTS_CHANGED=true
              else
                echo "==> requirements.txt unchanged, skipping dependency installation"
              fi
            else
              echo "==> No code changes, skipping dependency check"
            fi
            
            if [ "$REQUIREMENTS_CHANGED" = true ]; then
              echo "==> Installing dependencies..."
              .venv/bin/pip install -r requirements.txt --upgrade
            fi
          else
            echo "==> No requirements.txt found"
          fi
          
          echo "==> About to restart service: ${{ env.SERVICE_NAME }}"
          echo "==> Checking service status BEFORE restart:"
          sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager | head -5
          
          echo "==> Running: sudo systemctl restart ${{ env.SERVICE_NAME }}"
          if sudo systemctl restart ${{ env.SERVICE_NAME }}; then
            echo "==> ✓ Restart command succeeded"
          else
            echo "==> ✗ Restart command FAILED with exit code $?"
            exit 1
          fi
          
          echo "==> Waiting for service to start..."
          sleep 3
          
          echo "==> Checking service status AFTER restart:"
          sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager
          
          echo "=========================================="
          echo "Deployment complete"
          echo "=========================================="
          EOF

      - name: Verify deployment
        run: |
          sleep 2
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash -s << 'EOF'
          
          echo "=========================================="
          echo "Verifying deployment"
          echo "=========================================="
          
          echo "==> Service Status:"
          sudo systemctl status ${{ env.SERVICE_NAME }} --no-pager
          
          echo ""
          echo "==> Recent logs (last 30 lines):"
          tail -30 ${{ env.DEPLOY_PATH }}/run.log 2>/dev/null || echo "No logs yet"
          
          echo ""
          echo "==> Process check:"
          if pgrep -af 'src.main'; then
            echo "✓ Python process confirmed running"
          else
            echo "⚠ Warning: Process not found in pgrep"
          fi
          
          echo ""
          echo "==> Service journal (last 20 lines):"
          sudo journalctl -u ${{ env.SERVICE_NAME }} -n 20 --no-pager
          
          echo "=========================================="
          echo "Verification complete"
          echo "=========================================="
          EOF

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Path: ${{ env.DEPLOY_PATH }}"

      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."