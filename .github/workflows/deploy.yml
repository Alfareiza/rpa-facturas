name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers from GitHub UI

env:
  DEPLOY_PATH: ~/Projects/rpa-facturas-mutualser
  SERVICE_NAME: rpa-facturas-mutualser

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          install -m 0700 -d ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            -o ServerAliveInterval=5 \
            -o ServerAliveCountMax=3 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && \
             echo '==========================================' && \
             echo 'Starting deployment for ${{ env.SERVICE_NAME }}' && \
             echo '==========================================' && \
             BEFORE_COMMIT=\$(git rev-parse HEAD) && \
             echo '==> Pulling latest changes from Git' && \
             git pull && \
             AFTER_COMMIT=\$(git rev-parse HEAD) && \
             if [ \"\$BEFORE_COMMIT\" = \"\$AFTER_COMMIT\" ]; then \
               echo '==> No new commits, repository already up to date'; \
             else \
               echo \"==> Updated from \$BEFORE_COMMIT to \$AFTER_COMMIT\"; \
             fi && \
             echo '==> Checking virtual environment' && \
             if [ ! -d .venv ]; then \
               echo '==> Creating virtual environment' && \
               make venv && \
               VENV_CREATED=true; \
             else \
               VENV_CREATED=false; \
             fi && \
             REQUIREMENTS_CHANGED=false && \
             if [ -f requirements.txt ]; then \
               if [ \"\$VENV_CREATED\" = true ]; then \
                 echo '==> New virtual environment created, installing dependencies' && \
                 REQUIREMENTS_CHANGED=true; \
               elif [ \"\$BEFORE_COMMIT\" != \"\$AFTER_COMMIT\" ]; then \
                 if git diff --name-only \$BEFORE_COMMIT \$AFTER_COMMIT | grep -q '^requirements.txt$'; then \
                   echo '==> requirements.txt changed, updating dependencies' && \
                   REQUIREMENTS_CHANGED=true; \
                 else \
                   echo '==> requirements.txt unchanged, skipping dependency installation'; \
                 fi; \
               else \
                 echo '==> No code changes, skipping dependency check'; \
               fi && \
               if [ \"\$REQUIREMENTS_CHANGED\" = true ]; then \
                 .venv/bin/pip install -r requirements.txt --upgrade; \
               fi; \
             else \
               echo '==> No requirements.txt found, skipping dependency installation'; \
             fi && \
             echo '==> Restarting service' && \
             sudo systemctl restart ${{ env.SERVICE_NAME }} && \
             echo '==> Waiting for service to start...' && \
             sleep 3 && \
             echo '==========================================' && \
             echo 'Deployment complete' && \
             echo '==========================================' \
            "

      - name: Verify deployment
        run: |
          sleep 2
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            'sudo systemctl status rpa-facturas-mutualser --no-pager'
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          SERVICE_NAME: ${{ env.SERVICE_NAME }}

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Path: ${{ env.DEPLOY_PATH }}"

      - name: Deployment failed
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."
          echo "You can manually check the service with:"
          echo "  sudo systemctl status ${{ env.SERVICE_NAME }}"
          echo "  tail -50 ${{ env.DEPLOY_PATH }}/run.log"