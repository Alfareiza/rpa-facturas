name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  DEPLOY_PATH: ~/Projects/rpa-facturas-mutualser
  SERVICE_NAME: rpa-facturas-mutualser

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          install -m 0700 -d ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -tt -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd ~/Projects/rpa-facturas-mutualser && \
             echo '=========================================='; \
             echo 'Starting deployment'; \
             echo '=========================================='; \
             git pull; \
             echo '==> Restarting service...'; \
             sudo systemctl restart rpa-facturas-mutualser; \
             sleep 3; \
             echo '==> Service restarted'; \
             sudo systemctl status rpa-facturas-mutualser --no-pager | head -5; \
             echo '==========================================';"

      - name: Verify deployment  
        run: |
          sleep 2
          ssh -tt -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "echo '=========================================='; \
             echo 'Verification'; \
             echo '=========================================='; \
             sudo systemctl status rpa-facturas-mutualser --no-pager; \
             echo ''; \
             echo 'Recent logs:'; \
             tail -20 ~/Projects/rpa-facturas-mutualser/run.log 2>/dev/null || echo 'No logs'; \
             echo ''; \
             pgrep -af 'src.main' || echo 'Process not found'; \
             echo '==========================================';"

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Deployment summary
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Service: ${{ env.SERVICE_NAME }}"
          echo "Path: ${{ env.DEPLOY_PATH }}"

      - name: Deployment failed
        if: failure()
        run: echo "❌ Deployment failed!"